import Table from"./table.min.js";import controller from"./controller.min.js";import ModalController from"./modalController.min.js";import{Employee,Department,Location}from"./dataTypes.min.js";import K from"../modules/kaigen.min.js";class App{_controller=controller;_employees=Employee.data;_departments=Department.data;_locations=Location.data;_selectedRows=[];_selectedTable="employees";_table=null;_formModal=null;_filterButton=document.getElementById("filter");_searchInput=document.getElementById("search");_search="";_filters={departments:[],locations:[]};_sort={by:"_id",order:""};get employees(){return this._employees}get departments(){return this._departments}get locations(){return this._locations}get search(){return this._search}set search(e){this._search=e}filterSearch(e){this._table._body.render()}async getData(e){[Employee,Department,Location].forEach((e=>e.clear()));const t=await Promise.all([controller.getEmployees(),controller.getDepartments(),controller.getLocations()]),[l,n,o]=t;o.forEach((e=>new Location(e))),n.forEach((e=>{const t=Location.getByName(e.location);new Department({...e,location:t})})),l.forEach((e=>{const t=Location.getByName(e.location),l=Department.getByName(e.department);new Employee({...e,department:l,location:t})})),e||this.tableSelect(this._selectedTable)}handleSearchInput=e=>{this._search=e.target.value,this._table._body.render()};tableSelect(e){const t=e instanceof Event?e.target.value:e,l=(document.querySelector("#count>button"),document.querySelector("#count>button>svg"),document.createElement("i")),n=document.querySelector("#count>button>span"),o=document.querySelector("#count>button>p");l.className={employees:"fa-solid fa-people-group fa-lg me-2",departments:"fa-solid fa-building fa-lg me-2",locations:"fa-solid fa-location-dot fa-lg me-2"}[t],n.innerHTML=K.toTitle(t),o.innerHTML=`(${this[`_${t}`].count})`,this._search="",this._selectedRows=[],this._selectedTable=t,this.insertFormOptions(),this.renderCRUDButtons(),this.renderFilterButton(),this.renderTable()}insertFormOptions(){const e=document.getElementById("department"),t=document.getElementById("location"),l=document.getElementById("department-location");[e,t,l].forEach((e=>e?e.innerHTML="":void 0));const n=(e,t)=>{const l=document.createElement("option");l.value=e._name,l.innerHTML=e._name,t.append(l)};e&&t?(this._departments.list.forEach((t=>n(t,e))),this._locations.list.forEach((e=>n(e,t)))):l&&this._locations.list.forEach((e=>n(e,l)))}renderFilterButton(){const e=document.getElementById("filter-container");if(this._filterButton.remove(),this._filters={departments:[],locations:[]},this[`_${this._selectedTable}`].list[0]instanceof Employee){e.prepend(this._filterButton);const t=document.getElementById("filter-dep"),l=document.getElementById("filter-loc");t.innerHTML="",l.innerHTML="";const n=(e,t,l)=>{const n=document.createElement("li"),o=document.createElement("label"),a=document.createElement("input");o.classList.add("dropdown-item"),a.setAttribute("type","checkbox"),a.setAttribute("value",e),a.addEventListener("change",(t=>{t.target.checked?this._filters[l].push(e):this._filters[l]=this._filters[l].filter((t=>t!==e)),this.renderTable()})),o.append(a,e),n.appendChild(o),t.append(n)};this.departments.list.forEach((e=>{n(e._name,t,"departments")})),this.locations.list.forEach((e=>{n(e._name,l,"locations")}))}}applyFilters(e){return(e=[...e])[0]instanceof Employee&&(this._filters.locations.length>0||this._filters.departments.length>0)&&(e=e.filter((e=>{const t=this._filters.departments.includes(e._department),l=this._filters.locations.includes(e._location);return t||l}))),e}renderCRUDButtons(){const e={},t=this._selectedTable,l=this._selectedRows;["add-employee","edit-employee","delete-employee","add-department","edit-department","delete-department","add-location","edit-location","delete-location"].forEach((n=>{let o=K.toTitle(n.replace("-"," "));const a=document.getElementById(n);e[n]=a.cloneNode(!0),a.parentNode.replaceChild(e[n],a),e[n].lastChild.nodeValue=o,n.includes("add")?e[n].addEventListener("click",(e=>{this._formModal.bs.show(),this._formModal.handleModalShow(e)})):(0===l.length&&(e[n].disabled=!0),l.length>0&&t.includes(o.split(" ")[1].toLowerCase())&&(e[n].disabled=!1),l.length>1&&t.includes(o.split(" ")[1].toLowerCase())&&(e[n].lastChild.nodeValue=o+"s"),n.includes("edit")&&e[n].addEventListener("click",(e=>{this._formModal.bs.show(),this._formModal.handleModalShow(e)})),n.includes("delete")&&e[n].addEventListener("click",(e=>{this._formModal.handleWarn("delete",(async()=>{await Promise.all(this._selectedRows.map((async e=>{n.includes("employee")?await controller.deleteEmployee(e.data.id):n.includes("department")?await controller.deleteDepartment(e.data.id):n.includes("location")&&await controller.deleteLocation(e.data.id)}))),await this.getData(),this.tableSelect(this._selectedTable)}),this._selectedRows.length>1)})))}))}renderTable(){this._table=new Table("table",this.applyFilters(this[`_${this._selectedTable}`].list),this),this._table.render(),this.enableBSTooltips()}enableBSTooltips(){[...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map((e=>new bootstrap.Tooltip(e)))}toggleLoader(e){const t=document.getElementById("loader");t.classList.contains("clear")||(t.classList.add("init"),setTimeout((()=>{t.classList.add("clear")}),500)),"boolean"==typeof e?e?t.classList.contains("in")||t.classList.add("in"):t.classList.contains("in")&&setTimeout((()=>{t.classList.remove("in")}),500):t.classList.toggle("in")}async willRun(){const e=document.querySelectorAll("#count>ul>li>button");controller.addEventListener("requesting",(e=>{this.toggleLoader(!0)})),controller.addEventListener("fulfilled",(e=>{this.toggleLoader(!1)})),Array.from(document.querySelectorAll("main:not(input)")).forEach((e=>{e.addEventListener("contextmenu",(e=>{e.preventDefault()}))})),document.getElementById("refresh").addEventListener("click",(async e=>{await this.getData(),this.tableSelect(this._selectedTable)})),document.getElementById("logo").addEventListener("click",(e=>window.scrollTo({top:0,left:0,behavior:"smooth"}))),document.getElementById("department").addEventListener("input",(e=>{const t=e.target.value,l=Department.getByName(t).location.name;document.getElementById("location").value=l})),e.forEach((e=>{e.addEventListener("click",this.tableSelect.bind(this))})),this._searchInput.addEventListener("input",this.handleSearchInput.bind(this)),this._searchInput.addEventListener("keydown",(e=>27===e.keyCode?e.preventDefault():void 0)),document.addEventListener("keydown",(e=>{65===e.keyCode&&e.ctrlKey&&(e.preventDefault(),this._table._body.selectAllRows(),this.renderCRUDButtons())})),this._searchInput.addEventListener("keydown",(e=>{65===e.keyCode&&e.ctrlKey&&(e.preventDefault(),e.target.select())})),document.getElementById("touch-select").addEventListener("click",(e=>{this[`_${this._selectedTable}`].list.length>this._selectedRows.length?(e.currentTarget.classList.add("active"),this._table._body.selectAllRows()):(e.currentTarget.classList.remove("active"),this._table._body.deselectAllRows())})),document.getElementById("touch-cancel").addEventListener("click",(e=>{this._table._body._touchSelectEnabled=!1,document.getElementById("touch-controls").classList.add("hide"),document.getElementById("touch-select").classList.remove("active")})),await this.getData()}async run(){await this.willRun(!0),$((async()=>{this.tableSelect("employees"),this._formModal=new ModalController(this,"#form-modal")}))}}export{App};export default new App;
