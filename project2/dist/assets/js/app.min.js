import K from"../modules/kaigen.min.js";class App{_controller=new Controller;_employees=Employee.data;_departments=Department.data;_locations=Location.data;_selectedRows=[];_selectedTable="employees";_table=null;_formModal=null;_filterButton=document.getElementById("filter");_searchInput=document.getElementById("search");_search="";_filters={departments:[],locations:[]};_sort={by:"_id",order:""};get employees(){return this._employees}get departments(){return this._departments}get locations(){return this._locations}get search(){return this._search}set search(t){this._search=t}filterSearch(t){this._table._body.render()}async getData(t){[Employee,Department,Location].forEach((t=>t.clear()));const e=await Promise.all([controller.getEmployees(),controller.getDepartments(),controller.getLocations()]),[s,a,i]=e;i.forEach((t=>new Location(t))),a.forEach((t=>{const e=Location.getById(t.location);new Department({...t,location:e})})),s.forEach((t=>{const e=Location.getById(t.location),s=Department.getById(t.department);new Employee({...t,department:s,location:e})})),t||this.tableSelect(this._selectedTable)}handleSearchInput=t=>{this._search=t.target.value,this._table._body.render()};tableSelect(t){const e=t instanceof Event?t.target.value:t,s=(document.querySelector("#count>button"),document.querySelector("#count>button>svg"),document.createElement("i")),a=document.querySelector("#count>button>span"),i=document.querySelector("#count>button>p");s.className={employees:"fa-solid fa-people-group fa-lg me-2",departments:"fa-solid fa-building fa-lg me-2",locations:"fa-solid fa-location-dot fa-lg me-2"}[e],a.innerHTML=K.toTitle(e),i.innerHTML=`(${this[`_${e}`].count})`,this._search="",this._selectedRows=[],this._selectedTable=e,this.insertFormOptions(),this.renderCRUDButtons(),this.renderFilterButton(),this.renderTable()}insertFormOptions(){const t=document.getElementById("department"),e=document.getElementById("location"),s=document.getElementById("department-location");[t,e,s].forEach((t=>t?t.innerHTML="":void 0));const a=(t,e)=>{const s=document.createElement("option");s.value=t._name,s.innerHTML=t._name,e.append(s)};t&&e?(this._departments.list.sort(((t,e)=>t.name>e.name?1:t.name<e.name?-1:0)).forEach((e=>a(e,t))),this._locations.list.sort(((t,e)=>t.name>e.name?1:t.name<e.name?-1:0)).forEach((t=>a(t,e)))):s&&this._locations.list.sort(((t,e)=>t.name>e.name?1:t.name<e.name?-1:0)).forEach((t=>a(t,s)))}renderFilterButton(){const t=document.getElementById("filter-container");if(this._filterButton.remove(),this._filters={departments:[],locations:[]},this[`_${this._selectedTable}`].list[0]instanceof Employee){t.prepend(this._filterButton);const e=document.getElementById("filter-dep"),s=document.getElementById("filter-loc");e.innerHTML="",s.innerHTML="";const a=(t,e,s)=>{const a=document.createElement("li"),i=document.createElement("label"),o=document.createElement("input");i.classList.add("dropdown-item"),o.setAttribute("type","checkbox"),o.setAttribute("value",t),o.addEventListener("change",(e=>{e.target.checked?this._filters[s].push(t):this._filters[s]=this._filters[s].filter((e=>e!==t)),this.renderTable()})),i.append(o,t),a.appendChild(i),e.append(a)};this.departments.list.forEach((t=>{a(t._name,e,"departments")})),this.locations.list.forEach((t=>{a(t._name,s,"locations")}))}}applyFilters(t){return(t=[...t])[0]instanceof Employee&&(this._filters.locations.length>0||this._filters.departments.length>0)&&(t=t.filter((t=>{const e=this._filters.departments.includes(t._department),s=this._filters.locations.includes(t._location);return e||s}))),t}async renderCRUDButtons(){const t={},e=this._selectedTable,s=this._selectedRows;["add-employee","edit-employee","delete-employee","add-department","edit-department","delete-department","add-location","edit-location","delete-location"].forEach((a=>{let i=K.toTitle(a.replace("-"," "));const o=document.getElementById(a);t[a]=o.cloneNode(!0),o.parentNode.replaceChild(t[a],o),t[a].lastChild.nodeValue=i,a.includes("add")?t[a].addEventListener("click",(async t=>{await this._formModal.handleModalShow(t),this._formModal.bs.show()})):(0===s.length&&(t[a].disabled=!0),s.length>0&&e.includes(i.split(" ")[1].toLowerCase())&&(t[a].disabled=!1),s.length>1&&e.includes(i.split(" ")[1].toLowerCase())&&(t[a].lastChild.nodeValue=i+"s"),a.includes("edit")&&t[a].addEventListener("click",(async t=>{await this._formModal.handleModalShow(t),this._formModal.bs.show()})),a.includes("delete")&&t[a].addEventListener("click",this.handleNoModalDelete.bind(this)))}))}handleNoModalDelete(t){const e=t.target.id;this._formModal.handleWarn("delete",(async t=>{await Promise.all(this._selectedRows.map((async t=>{e.includes("employee")?await controller.deleteEmployee(t.data.id):e.includes("department")?await controller.deleteDepartment(t.data.id):e.includes("location")&&await controller.deleteLocation(t.data.id)}))),await this.getData(),this.tableSelect(this._selectedTable)}),this._selectedRows.length>1)}renderTable(){this._table=new Table("table",this.applyFilters(this[`_${this._selectedTable}`].list),this),this._table.render(),this.enableBSTooltips()}enableBSTooltips(){[...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map((t=>new bootstrap.Tooltip(t)))}toggleLoader(t){const e=document.getElementById("loader");e.classList.contains("clear")||(e.classList.add("init"),setTimeout((()=>{e.classList.add("clear")}),500)),"boolean"==typeof t?t?e.classList.contains("in")||e.classList.add("in"):e.classList.contains("in")&&setTimeout((()=>{e.classList.remove("in")}),500):e.classList.toggle("in")}async willRun(){const t=document.querySelectorAll("#count>ul>li>button");controller.addEventListener("requesting",(t=>{this.toggleLoader(!0)})),controller.addEventListener("fulfilled",(t=>{this.toggleLoader(!1)})),Array.from(document.querySelectorAll("main:not(input)")).forEach((t=>{t.addEventListener("contextmenu",(t=>{t.preventDefault()}))})),document.getElementById("refresh").addEventListener("click",(async t=>{await this.getData(),this.tableSelect(this._selectedTable)})),document.getElementById("department").addEventListener("input",(t=>{const e=Department.getByName(t.target.value),s=e.location.name?e.location.name:e.location;document.getElementById("location").value=s})),t.forEach((t=>{t.addEventListener("click",this.tableSelect.bind(this))})),this._searchInput.addEventListener("input",this.handleSearchInput.bind(this)),this._searchInput.addEventListener("keydown",(t=>27===t.keyCode?t.preventDefault():void 0)),document.addEventListener("keydown",(t=>{65===t.keyCode&&t.ctrlKey&&(t.preventDefault(),this._table._body.selectAllRows(),this.renderCRUDButtons())})),this._searchInput.addEventListener("keydown",(t=>{65===t.keyCode&&t.ctrlKey&&(t.preventDefault(),t.target.select())})),document.getElementById("touch-select").addEventListener("click",(t=>{this[`_${this._selectedTable}`].list.length>this._selectedRows.length?(t.currentTarget.classList.add("active"),this._table._body.selectAllRows()):(t.currentTarget.classList.remove("active"),this._table._body.deselectAllRows())})),document.getElementById("touch-cancel").addEventListener("click",(t=>{this._table._body._touchSelectEnabled=!1,document.getElementById("touch-controls").classList.add("hide"),document.getElementById("touch-select").classList.remove("active")})),await this.getData()}async run(){await this.willRun(!0),$((async()=>{this.tableSelect("employees"),this._formModal=new ModalController(this,"#form-modal")}))}}class Employee{static data={count:0,list:[]};_id;_firstName;_lastName;_email;_jobTitle;_department;_location;constructor({id:t,firstName:e,lastName:s,email:a,jobTitle:i,department:o,location:n},r=!0){this.#t(t),this.#e(e),this.#s(s),this.#a(a),this.#i(i),this.#o(o),this.#n(n),r&&(Employee.data.count++,Employee.data.list.push(this))}get id(){return this._id}#t(t){if(t=Number(t),isNaN(t))throw new Error("Department ID must be of type number");this._id=t}get firstName(){return this._firstName}#e(t){if("string"!=typeof t)throw new Error("Firstname must be of type string.");this._firstName=t}get lastName(){return this._lastName}#s(t){if("string"!=typeof t)throw new Error("Lastname must be of type string.");this._lastName=t}get email(){return this._email}#a(t){if("string"!=typeof t)throw new Error("Email must be of type string.");this._email=t}get jobTitle(){return this._jobTitle}#i(t){if("string"!=typeof t)throw new Error("Job Title must be of type string.");this._jobTitle=t}get department(){return this._department}#o(t){if(!(t instanceof Department))throw new Error("You must set the department as an instance of Department");this._department=t}get location(){return this._department}#n(t){if(!(t instanceof Location))throw new Error("You must set the location as an instance of Location");this._location=t}replace(t){const e=Employee.data.list.findIndex((t=>t.id===this.id));Employee.data.list[e]=t}async getLatestData(){const t=await controller.getEmployeeById(this.id);t.department=Department.getById(t.department),t.location=Location.getById(t.location);const e=new Employee(t,!1);return this.replace(e),e}static getById(t){return Employee.data.list.filter((e=>t==e.id))[0]}static async clear(){Employee.data.count=0,Employee.data.list=[]}static async add(t,e){await controller.addEmployee(t),e&&e()}static async edit(t,e){await controller.editEmployee(t),e&&e()}static async delete(t,e){await controller.deleteEmployee(t),e&&e()}async add(t,e){await Employee.add(t,e)}async edit(t,e){await Employee.edit(t,e)}async delete(t,e){await Employee.delete(t,e)}}class Department{static data={count:0,list:[]};_id;_name;_location;constructor({id:t,name:e,location:s},a=!0){this.#t(t),this.#r(e),this.#n(s),a&&(Department.data.count++,Department.data.list.push(this))}get id(){return this._id}#t(t){if(t=Number(t),isNaN(t))throw new Error("Department ID must be of type number");this._id=t}get name(){return this._name}#r(t){if("string"!=typeof t)throw new Error("Department name must be of type string.");this._name=t}get location(){return this._location}#n(t){if(!(t instanceof Location))throw new Error("You must set the location as an instance of Location");this._location=t}replace(t){const e=Department.data.list.findIndex((t=>t.id===this.id));Department.data.list[e]=t}async getLatestData(){const t=await controller.getDepartmentById(this.id);t.location=Location.getById(t.location);const e=new Department(t,!1);return this.replace(e),e}async hasEmployees(){return await controller.getDepartmentEmployeeCount(this.id)>0}static getById(t){return Department.data.list.filter((e=>t==e.id))[0]}static getByName(t){return Department.data.list.filter((e=>t===e.name))[0]}static clear(){Department.data.count=0,Department.data.list=[]}static async add(t,e){await controller.addDepartment(t),e&&e()}static async edit(t,e){await controller.editDepartment(t),e&&e()}static async delete(t,e){await controller.deleteDepartment(t),e&&e()}async add(t,e){await Department.add(t,e)}async edit(t,e){await Department.edit(t,e)}async delete(t,e){await Department.delete(t,e)}}class Location{static data={count:0,list:[]};_id;_name;constructor({id:t,name:e},s=!0){this.#t(t),this.#r(e),s&&(Location.data.count++,Location.data.list.push(this))}get id(){return this._id}#t(t){if(t=Number(t),isNaN(t))throw new Error("Location ID must be of type number");this._id=t}get name(){return this._name}#r(t){if("string"!=typeof t)throw new Error("Location name must be of type string.");this._name=t}replace(t){const e=Location.data.list.findIndex((t=>t.id===this.id));Location.data.list[e]=t}async getLatestData(){const t=await controller.getLocationById(this.id),e=new Location(t,!1);return this.replace(e),e}async hasDepartments(){return await controller.getLocationDepartmentCount(this.id)>0}static getById(t){return Location.data.list.filter((e=>t==e.id))[0]}static getByName(t){return Location.data.list.filter((e=>t===e.name))[0]}static clear(){Location.data.count=0,Location.data.list=[]}static async add(t,e){await controller.addLocation(t),e&&e()}static async edit(t,e){await controller.editLocation(t),e&&e()}static async delete(t,e){await controller.deleteLocation(t),e&&e()}async add(t,e){await Location.add(t,e)}async edit(t,e){await Location.edit(t,e)}async delete(t,e){await Location.delete(t,e)}}class Controller extends EventTarget{_requesting=!1;_requests=[];constructor(){super()}setRequesting(t){if("boolean"!=typeof t)throw new Error("Requesting must be of type boolean.");this._requesting=t}async request(t){const e=new Pajax(t);this.addRequest(e);const s=await e.fetch();return this.removeRequest(e),s.data}addRequest(t){if(0===this._requests.length){const t=new Event("requesting");this.dispatchEvent(t),this.setRequesting(!0)}this._requests.push(t)}removeRequest(t){if(this._requests=this._requests.filter((e=>e!==t)),0===this._requests.length){const t=new Event("fulfilled");this.setRequesting(!1),this.dispatchEvent(t)}}handleRequesting(t){this._onRequesting.forEach((e=>e(t)))}handleFulfilled(t){this._onFulfilled.forEach((e=>e(t)))}async getEmployees(){return await this.request({url:`${uri}employees.php`})}async getEmployeeById(t){return await this.request({url:`${uri}employees.php`,data:{id:t}})}async addEmployee(t){return await this.request({url:`${uri}employees.php`,data:t,type:"POST"})}async editEmployee(t){return await this.request({url:`${uri}employees.php`,data:t,type:"PUT"})}async deleteEmployee(t){return await this.request({url:`${uri}employees.php`,data:{id:t},type:"DELETE"})}async getDepartments(){return await this.request({url:`${uri}departments.php`})}async getDepartmentById(t){return await this.request({url:`${uri}departments.php`,data:{id:t}})}async getDepartmentEmployeeCount(t){return(await this.request({url:`${uri}departments.php`,data:{count:t}})).count}async addDepartment(t){return await this.request({url:`${uri}departments.php`,data:t,type:"POST"})}async editDepartment(t){return await this.request({url:`${uri}departments.php`,data:t,type:"PUT"})}async deleteDepartment(t){return await this.request({url:`${uri}departments.php`,data:{id:t},type:"DELETE"})}async getLocations(){return await this.request({url:`${uri}locations.php`})}async getLocationById(t){return await this.request({url:`${uri}locations.php`,data:{id:t}})}async getLocationDepartmentCount(t){return(await this.request({url:`${uri}locations.php`,data:{count:t}})).count}async addLocation(t){return await this.request({url:`${uri}locations.php`,data:t,type:"POST"})}async editLocation(t){return await this.request({url:`${uri}locations.php`,data:t,type:"PUT"})}async deleteLocation(t){return await this.request({url:`${uri}locations.php`,data:{id:t},type:"DELETE"})}}class Pajax extends EventTarget{_params=null;_requesting=!1;_error=!1;_onRequesting=[()=>this.setRequesting(!0)];_onFulfilled=[()=>this.setRequesting(!1)];_onError=[()=>this.setRequesting(!1)];constructor(t){super(),this._params=t,this.addEventListener("requesting",this.handleRequesting.bind(this)),this.addEventListener("fulfilled",this.handleFulfilled.bind(this)),this.addEventListener("error",this.handleError.bind(this))}get requesting(){return this._requesting}setRequesting(t){if("boolean"!=typeof t)throw new Error("Requesting must be of type boolean.");this._requesting=t}handleRequesting(t){this._onRequesting.forEach((e=>e(t)))}handleFulfilled(t){this._onFulfilled.forEach((e=>e(t)))}handleError(t){this._onError.forEach((e=>e(t)))}pajax({url:t,type:e="GET",dataType:s="json",data:a}){return new Promise((i=>{this.dispatchEvent(requestingEvent),$.ajax({url:t,type:e,dataType:s,data:a,success:t=>{this.dispatchEvent(fulfilledEvent),i(t)},error:(t,e,s)=>{errorEvent.error={jqXHR:t,textStatus:e,err:s},console.error(errorEvent),this.dispatchEvent(errorEvent)}})}))}async fetch(){return await this.pajax(this._params)}}class ModalController{_app=null;_forms=[];_selectedForm=0;_selectedRow=0;_modal=null;_table=null;_type=null;_bs=null;_buttons={};_isEditied=!1;constructor(t,e){this.setApp(t),this.setModal(e),this.setForms(this.modal.querySelectorAll("form")),["#edit","#delete","#prev","#next"].forEach((t=>this.setButton(t))),this.forms.forEach((t=>{t.addEventListener("input",(t=>this.setIsEdited(!0)))})),this.buttons.delete.addEventListener("click",this.handleDelete.bind(this)),this.run()}get app(){return this._app}setApp(t){if(!(t instanceof App))throw new Error("The modal controllers app must be an instance of App.");this._app=t}get forms(){return this._forms}setForms(t){Array.from(t).forEach((t=>{if(!(t instanceof HTMLFormElement))throw new Error("All forms must be instances of a HTMLFormElement.");this._forms.push(t)}))}get selectedForm(){return this._selectedForm}setSelectedForm(t){this._selectedForm=t}get bs(){return this._bs}get modal(){return this._modal}setModal(t){const e=document.querySelector(t);if(!(e instanceof HTMLElement))throw new Error("The modal needs to be a valid HTML element.");this._modal=e,this._bs=new bootstrap.Modal(this.modal,{backdrop:"static"})}get buttons(){return this._buttons}setButton(t){this._buttons[t.slice(1)]=this.modal.querySelector(t)}get isEditied(){return this._isEditied}setIsEdited(t){this._isEditied=t,this.modal.querySelector("#modal-submit").disabled=!1}get selectedRow(){return this._selectedRow}get type(){return this._type}setType(t){this._type=t}get table(){return this._table}setTable(t){this._table=t}async setSelectedRow(t){if("function"==typeof t)this._selectedRow=t(this._selectedRow,this.app._selectedRows);else{if("number"!=typeof t)throw new Error("You can only set the selected row using a function of a number");this._selectedRow=t}await this.app._selectedRows[this.selectedRow].data.getLatestData()}insertSelectedRow(){Array.from(this.forms[this.selectedForm].querySelectorAll("input, select")).forEach((t=>{const e=t.getAttribute("name"),s=this.app._selectedRows[this.selectedRow].data[`_${e}`];t.value=s}))}disableButtons(){this.modal.classList.remove("editing");for(let t in this.buttons)this.buttons[t].disabled=!0}toggleReadOnly(t,e){const s=Array.from(this.modal.querySelectorAll("input, select"));t?(this.modal.classList.remove("editing"),s.forEach((t=>t.disabled=!0))):(this.modal.classList.add("editing"),s.forEach((t=>{"employees"===e&&"location"===t.name?t.disabled=!0:t.disabled=!1})))}handleClose(t){this.handleWarn("close",this.bs.hide.bind(this.bs))}getLocationByName(t){return this.app._locations.list.filter((e=>e.name===t))[0]}getDepartmentByName(t){return this.app._departments.list.filter((e=>e.name===t))[0]}async handleDelete(){this.handleWarn("delete",(async()=>{let t=[...this.app._selectedRows],e={...this.app._selectedRows[this.selectedRow]};const s=Number(this.app._selectedRows[this.selectedRow].data.id);"employees"===this.table?await Employee.delete(s):"departments"===this.table?await Department.delete(s):"locations"===this.table&&await Location.delete(s),await this.app.getData(),this.app.tableSelect(this.app._selectedTable),1===t.length?this.bs.hide():this.handleMultiSubmitDelete(t,e),this.setIsEdited(!1)}))}async handleSubmit(t){const e=new FormData(this.forms[this.selectedForm]),s=this.parseForm(e),a="employees"===this.table?Employee:"departments"===this.table?Department:Location;let i,o;if(this.forms[this.selectedForm].reportValidity())try{"add"===this.type?(delete s.id,await a.add(s)):"edit"===this.type&&(i=[...this.app._selectedRows],o={...this.app._selectedRows[this.selectedRow]},await a.edit(s)),await this.app.getData(),this.app.tableSelect(this.app._selectedTable),"add"===this.type||"edit"===this.type&&1===i.length?this.bs.hide():this.handleMultiSubmitDelete(i,o),this.setIsEdited(!1)}catch(t){console.error(t)}}parseForm(t){const e={};for(let[s,a]of t)"department"===s&&(s+="ID",a=this.getDepartmentByName(a).id),"location"===s&&(s+="ID",a=this.getLocationByName(a).id),e[s]=a;return e}handleMultiSubmitDelete(t,e){this.app._selectedRows=this.app._table._body.rows.filter((e=>t.findIndex((t=>t._data.id===e._data.id))>=0)),this.app._selectedRows=this.app._selectedRows.filter((t=>t._data.id!==e._data.id&&(t.ctrlClick(),!0))),this.selectedRow===this.app._selectedRows.length&&this.setSelectedRow(this.app._selectedRows.length-1),1===this.app._selectedRows.length&&(this.buttons.next.disabled=!0,this.buttons.prev.disabled=!0),this.insertSelectedRow()}async handleWarn(t,e,s=!1){const a=document.querySelector("header"),i=document.querySelector("main"),o=document.getElementById("change-handler"),n=bootstrap.Toast.getOrCreateInstance(o,{autohide:!1}),r=o.querySelector(".btn-danger"),l=o.querySelector(".btn-secondary");r.classList.remove("none");const d=()=>{this.modal.classList.remove("disabled"),a.classList.remove("disabled"),i.classList.remove("disabled"),n.hide()},c=()=>{r.removeEventListener("click",h),l.removeEventListener("click",p)},h=t=>{this.setIsEdited(!1),d(),e(),c()},p=t=>{d(),c()},m=(t,e,s)=>{e||r.classList.add("none"),this.modal.classList.add("disabled"),a.classList.add("disabled"),i.classList.add("disabled"),r.addEventListener("click",h),l.addEventListener("click",p),t.childNodes[0].firstChild.nodeValue=s,n.show()};if("delete"===t&&("departments"===this._app._selectedTable||"locations"===this._app._selectedTable))if("departments"===this._app._selectedTable){if(s){let t=await Promise.all(this._app._selectedRows.map((async t=>await t.data.hasEmployees())));if(t=t.includes(!0),t)return void m(o,!1,"You cannot delete a department if it still contains employees.")}else if(await this.app._selectedRows[this.selectedRow].data.hasEmployees())return void m(o,!1,"You cannot delete a department if it still contains employees.")}else if("locations"===this._app._selectedTable)if(s){let t=await Promise.all(this._app._selectedRows.map((async t=>await t.data.hasDepartments())));if(t=t.includes(!0),t)return void m(o,!1,"You cannot delete a location if it still has departments.")}else if(await this.app._selectedRows[this.selectedRow].data.hasDepartments())return void m(o,!1,"You cannot delete a location if it still has departments.");if(this.isEditied&&"close"===t||"delete"===t)if("delete"===t){const t=this.app._selectedRows[this.selectedRow].data.firstName,e=t?`${t} ${this.app._selectedRows[this.selectedRow].data.lastName}`:this.app._selectedRows[this.selectedRow].data.name;m(o,!0,s?`Delete ${this.app._selectedRows.length} ${this._app._selectedTable}?`:`Delete ${e} from ${this._app._selectedTable}?`)}else"close"===t&&m(o,!0,"You will lose any unsaved changes. Proceed?");else e()}async handleModalShow(t){const e=t.target.getAttribute("data-bs-type");let[s,a,i]=e.split("-");a+="s",this.setType(s),this.setTable(a),this.disableButtons(),"add"!==s&&await this.setSelectedRow(0),this.setSelectedForm(this.forms.findIndex((t=>t.getAttribute("id")===a))),this.forms.forEach((t=>t.remove())),this.modal.querySelector(".modal-body").prepend(this.forms[this.selectedForm]),this.app.insertFormOptions(),this.modal.querySelector("#modal-submit").disabled=!0,"add"===s&&(Array.from(this.modal.querySelectorAll("input, select")).forEach((t=>{t instanceof HTMLInputElement?t.value="":t.value=t.firstChild.value})),this.form,this.toggleReadOnly(!1,a)),"edit"===s&&(this.insertSelectedRow(i),i?this.toggleReadOnly(!0,a):this.toggleReadOnly(!1,a),this.buttons.edit.disabled=!1,this.buttons.delete.disabled=!1,this.app._selectedRows.length>1&&(this.buttons.prev.disabled=!1,this.buttons.next.disabled=!1))}run(){this.buttons.next.addEventListener("click",(t=>{this.handleWarn("close",(()=>{this.setSelectedRow.bind(this)(((t,e)=>t+1===e.length?0:t+1)),this.insertSelectedRow()}).bind(this))})),this.buttons.prev.addEventListener("click",(t=>{this.handleWarn("close",(()=>{this.setSelectedRow.bind(this)(((t,e)=>t-1<0?e.length-1:t-1)),this.insertSelectedRow()}).bind(this))})),this.buttons.edit.addEventListener("click",(t=>{this.modal.classList.contains("editing")?this.toggleReadOnly(!0,this.app._selectedTable):this.toggleReadOnly(!1,this.app._selectedTable)})),this.modal.querySelector("#modal-submit").addEventListener("click",this.handleSubmit.bind(this)),this.modal.querySelector("#modal-cancel").addEventListener("click",this.handleClose.bind(this)),this.modal.querySelector("#modal-close").addEventListener("click",this.handleClose.bind(this))}}class Table{_app;_data;_root;_header;_body;constructor(t,e,s){if(this.setApp(s),!Array.isArray(e))throw new Error("The table data must be an array.");this.setData([...e]);const a=document.querySelector(t);if(!(a instanceof HTMLTableElement))throw new Error("The table root must be an instance of an HTMLTableElement.");this.setRoot(a)}get app(){return this._app}setApp(t){this._app=t}get data(){return this._data}setData(t){this._data=t}get root(){return this._root}setRoot(t){this._root=t}render(){this.root.innerHTML="",this._header=new TableHeader(this),this._body=new TableBody(this),document.getElementById("touch-select").classList.remove("active"),document.getElementById("touch-controls").classList.add("hide")}}class TableBody{_table;_root;_rows;_touchSelectEnabled=!1;constructor(t){this.setTable(t),this.render()}get table(){return this._table}setTable(t){this._table=t}get root(){return this._root}setRoot(t){this._root=t}get rows(){return this._rows}setRows(t){this._rows=t}sort(t){t=[...t];const e=this.table.app._sort.order;let s,a=this.table.app._sort.by;t[0]&&!(a in t[0])&&(this.table.app._sort.order=a="_id");const i={_firstName:"_lastName",_lastName:"_firstName",_department:"_lastName",_location:"_lastName"},o=(t,e,o)=>{let n,r,l=1,d=-1;return a in i&&(n=t[i[a]],r=e[i[a]],s=!0),"desc"===o&&(l=-1,d=1),t=t[a],e=e[a],t instanceof Object&&(t=t._name,e=e._name),s?t.toLowerCase()>e.toLowerCase()?l:t.toLowerCase()<e.toLowerCase()?d:s?n>r?1:-1:0:t.toLowerCase()>e.toLowerCase()?l:t.toLowerCase()<e.toLowerCase()?d:0};return t.length>0&&(Number.isNaN(Number(t[0][a]))?"asc"===e?t=t.sort(((t,e)=>o(t,e,"asc"))):"desc"===e&&(t=t.sort(((t,e)=>o(t,e,"desc")))):"asc"===e?t=t.sort(((t,e)=>t[a]-e[a])):"desc"===e&&(t=t.sort(((t,e)=>e[a]-t[a])))),t}filterSearch(t){const e=0===this.table.app._search.length?[""]:this.table.app._search.split(" ").filter((t=>""!==t)),s=document.getElementById("no-results");return 0===(t=t.filter((t=>{let s=!1;for(let a in t)for(let i of e)if(t[a]instanceof Object&&(t[a]=t[a]._name),t[a]=t[a].toString(),t[a].toLowerCase().includes(i.toLowerCase())){s=!0;break}return s}))).length&&s.classList.contains("none")?s.classList.remove("none"):t.length>0&&!s.classList.contains("none")&&s.classList.add("none"),t}selectAllRows(){this._rows.forEach((t=>{t.root.className.includes("selected")||t.ctrlClick()}))}deselectAllRows(){this._rows.forEach((t=>{t.root.classList.remove("selected")})),this.table.app._selectedRows=[]}render(){const t=document.createElement("tbody");this.root&&this.root.remove(),this.setRoot(t),this.setRows(this.sort(this.filterSearch(this.table.data)).map((t=>new Row(t,this)))),this.table.root.append(this.root)}}class TableHeader{_table;_root;_row;constructor(t){this.setTable(t),this.render()}get table(){return this._table}setTable(t){this._table=t}get root(){return this._root}setRoot(t){this._root=t}get row(){return this._row}setRow(t){this._row=t}renderSortButton(){const t=this.row._cells,e=["asc","desc"],s=document.querySelector("#sort>ul");s.innerHTML="",t.forEach((t=>{let a=t.children[0].innerText,i=`_${K.toCamel(a)}`;"_name"!==i||"_name"in this.table._data[0]?(a=[a],i=[i]):(a=["First Name","Last Name"],i=["_firstName","_lastName"]),a.forEach(((a,o)=>{e.forEach((e=>{((t,e,a,i)=>{const o=document.createElement("li"),n=document.createElement("button");n.className="dropdown-item",n.innerHTML=`${t} ${e.toUpperCase()}`,n.addEventListener("click",(t=>{for(;this.table.app._sort.by!==a||this.table.app._sort.order!==e;)i.click()})),o.appendChild(n),s.appendChild(o)})(a,e,i[o],t)}))}))}))}render(){let t=Object.keys(this.table.data[0]);this.root&&this.root.remove(),this.setRoot(document.createElement("thead")),this.setRow(new Row(t,this,"th")),this.table.root.append(this.root)}}class Row{_parent;_root;_data;_cells=[];constructor(t,e,s="td"){this.setParent(e),this.setData(t),this.render(s)}get data(){return this._data}setData(t){this._data=t}get parent(){return this._parent}setParent(t){this._parent=t}get root(){return this._root}setRoot(t){this._root=t}render(t){"th"===t?this.renderTH():this.renderTD()}handleHeaderClick(t){let e;const s=this.parent.table.app._sort.by,a=this.parent.table.app._sort.order;let i="_"+K.toCamel(t.target.innerText),o=["","asc","desc"];if(this._cells.forEach((t=>{t.className=""})),s!==i)"_name"!==i||i in this.parent.table._data[0]?(this.parent.table.app._sort.by=i,e=this.parent.table.app._sort.order="asc"):"_firstName"!==s&&"_lastName"!==s||"_lastName"===s&&""===a?(this.parent.table.app._sort.by="_firstName",e=this.parent.table.app._sort.order="asc"):"_firstName"===s&&"asc"===a?e=this.parent.table.app._sort.order="desc":"_firstName"===s&&"desc"===a?(this.parent.table.app._sort.by="_lastName",e=this.parent.table.app._sort.order="asc"):e=this.parent.table.app._sort.order="asc"===a?"desc":"";else{let t=o.findIndex((t=>a===t));2===t?t=0:t++,e=this.parent.table.app._sort.order=o[t]}""!==e&&t.currentTarget.classList.add(e),this.parent.table._body.render()}static isSelectedRow(t){return t.parent.table.app._selectedRows.includes(t)}async handleClick(t,e,s){t.ctrlKey?e&&Row.isSelectedRow(this)||this.ctrlClick(t):t.shiftKey?this.shiftClick(t):this.click(t),e&&("delete"===s?this.parent.table.app.handleNoModalDelete(t):(await this.parent.table.app._formModal.handleModalShow(t),this.parent.table.app._formModal.bs.show())),this.parent.table.app.renderCRUDButtons()}click(t){const e=t.currentTarget.className.includes("selected");this.parent._rows.forEach((t=>{t.root.classList.remove("selected")})),this.parent.table.app._selectedRows=[],e||(this.root.classList.add("selected"),this.parent.table.app._selectedRows.push(this))}ctrlClick(){Row.isSelectedRow(this)?this.parent.table.app._selectedRows=this.parent.table.app._selectedRows.filter((t=>t!==this)):this.parent.table.app._selectedRows.push(this),this.root.classList.toggle("selected")}shiftClick(t){if(0===this.parent.table.app._selectedRows.length)this.click();else if(t.currentTarget===this.parent.table.app._selectedRows[0].element)this.parent.table.app._selectedRows.forEach((t=>{t.click()})),this.parent.table.app._selectedRows=[];else{const t=this.parent._rows.findIndex((t=>t===this.parent.table.app._selectedRows[0])),e=[t,this.parent._rows.findIndex((t=>t===this))].sort(((t,e)=>t>e?1:t<e?-1:0));this.parent.table.app._selectedRows.slice(1).forEach((t=>{t.ctrlClick()}));for(let s=e[0];s<=e[1];s++)s!==t&&this.parent._rows[s].ctrlClick()}}handleLongTouch(t){const e=document.getElementById("touch-controls");this._isLongTouch=!0,this.parent._touchSelectEnabled=!this.parent._touchSelectEnabled,this.parent._touchSelectEnabled?(e.classList.remove("hide"),this.ctrlClick()):(e.classList.add("hide"),this.parent.deselectAllRows())}async getLatestData(){}renderTH(){this.setRoot(document.createElement("tr"));const t=document.createElement("th"),e=t.cloneNode(!1),s=this.data.findIndex((t=>"_firstName"===t));s>-1&&(this.data[s]="_name",this.setData(this.data.slice(0,s+1).concat(this.data.slice(s+2)))),this.root.append(t),this.root.append(e),this.data.forEach((t=>{if("_id"!==t){"ID"===(t=K.camelToTitle(t.slice(1))).toUpperCase()&&(t=t.toUpperCase());const e=document.createElement("th"),s=document.createElement("div"),a='<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 48 48"><path d="m14 28 10-10.05L34 28Z"/></svg>';s.className="fw-semibold d-flex justify-content-between align-items-center",e.addEventListener("click",this.handleHeaderClick.bind(this)),this._cells.push(e),this.root.append(e),e.append(s),s.append(t),s.innerHTML+=a}})),this.parent.root.append(this.root)}handleTouchStart=t=>{const e=t.touches[0].clientX,s=t.touches[0].clientY;let a=!1,i=!1;const o=setTimeout((()=>{i||(a=!0,this.handleLongTouch(t))}),500),n=async t=>{const e=document.getElementById("touch-controls"),s=document.getElementById("touch-select");let l=t.target.getAttribute("data-bs-type");l=l?l.split("-")[0]:l,clearTimeout(o),!this.parent._touchSelectEnabled||a||i?this.parent._touchSelectEnabled||a||i||l&&Row.isSelectedRow(this)&&(t.stopPropagation(),"delete"===l?this.parent.table.app.handleNoModalDelete(t):(await this.parent.table.app._formModal.handleModalShow(t),this.parent.table.app._formModal.bs.show())):(t.preventDefault(),l&&Row.isSelectedRow(this)||(this.ctrlClick(),0===this.parent.table.app._selectedRows.length&&(e.classList.add("hide"),this.parent._touchSelectEnabled=!1),this.parent.table.app._selectedRows.length<this.parent._rows.length?s.classList.remove("active"):s.classList.add("active")),l&&(t.stopPropagation(),"delete"===l?this.parent.table.app.handleNoModalDelete(t):(await this.parent.table.app._formModal.handleModalShow(t),this.parent.table.app._formModal.bs.show()))),this.parent.table.app.renderCRUDButtons(),t.target.removeEventListener("touchend",n),t.target.removeEventListener("touchmove",r)},r=t=>{(t.touches[0].clientX>e+32||t.touches[0].clientX<e-32||t.touches[0].clientY>s+32||t.touches[0].clientY<s-32)&&(i=!0)};a&&(t.preventDefault(),touchSelect.classList.remove("active")),t.target.addEventListener("touchend",n),t.target.addEventListener("touchmove",r)};renderTD(){const t=this.parent.table.app._selectedRows.findIndex((t=>t.data===this.data));if(t<0){this.setRoot(document.createElement("tr"));const t=document.createElement("td"),e=t.cloneNode(!1),s=document.createElement("button"),a=s.cloneNode(!1),i=s.cloneNode(!1);let o=Object.keys(this.data),n=Object.values(this.data);const r=o.findIndex((t=>"_firstName"===t));s.className="btn btn-secondary fw-semibold hw-44 p-2 rounded-pill mx-auto",s.innerHTML="_firstName"in this.data?`${this.data._firstName.slice(0,1)}${this.data._lastName.slice(0,1)}`.toUpperCase():1===this.data.name.split(" ").length||this.data.name.split(" ").length>2?this.data.name.slice(0,2).toUpperCase():this.data.name.split(" ").map((t=>t.slice(0,1))).join(""),s.setAttribute("data-bs-target","form-modal"),s.setAttribute("data-bs-type",`edit-${this.data.constructor.name.toLowerCase()}-readonly`),a.className="btn btn-sm btn-light border rounded me-1",i.className="btn btn-sm btn-light border rounded",a.innerHTML='<i class="fa-solid fa-sm fa-pen-to-square"></i>',i.innerHTML='<i class="fa-solid fa-sm fa-trash-can"></i>',a.setAttribute("data-bs-type",`edit-${this.data.constructor.name.toLowerCase()}`),i.setAttribute("data-bs-type",`delete-${this.data.constructor.name.toLowerCase()}`),i.setAttribute("id",`delete-${this.data.constructor.name.toLowerCase()}${this.data.id}`),r>-1&&(n[r]=`${n[r]} ${n[r+1]}`,n=n.slice(0,r+1).concat(n.slice(r+2))),[s,a,i].forEach((t=>{t.addEventListener("click",(e=>{e.stopPropagation(),this.handleClick.bind(this)(e,!0,t.getAttribute("data-bs-type").split("-")[0])})),t.addEventListener("touchstart",this.handleTouchStart.bind(this))})),this.root.addEventListener("click",this.handleClick.bind(this)),this.root.addEventListener("touchstart",this.handleTouchStart.bind(this)),t.appendChild(s),e.appendChild(a),e.appendChild(i),this.root.appendChild(t),this.root.appendChild(e),n.forEach(((t,e)=>{if("_id"!==Object.keys(this.data)[e]){t instanceof Object&&(t=t.name);const e=document.createElement("td"),s=document.createElement("div");e.setAttribute("data-bs-toggle","tooltip"),e.setAttribute("title",t),e.setAttribute("data-bs-delay",'{"show": 500, "hide": 0}'),this._cells.push(e),this.root.append(e),e.append(s),s.append(t)}})),this.parent.root.append(this.root)}else this.setRoot(this.parent.table.app._selectedRows[t].root),this._cells=this.parent.table.app._selectedRows[t]._cells,this.parent.root.append(this.root),this.parent.table.app._selectedRows[t]=this}}const app=new App,controller=app._controller,uri="http://directory.aidanklee.co.uk/api/",requestingEvent=new Event("requesting"),fulfilledEvent=new Event("fulfilled"),errorEvent=new Event("error");export{App};export default app;
