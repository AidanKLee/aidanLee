import K from"../modules/kaigen.min.js";class Table{_app;_data;_root;_header;_body;constructor(t,e,s){if(this.setApp(s),!Array.isArray(e))throw new Error("The table data must be an array.");this.setData([...e]);const a=document.querySelector(t);if(!(a instanceof HTMLTableElement))throw new Error("The table root must be an instance of an HTMLTableElement.");this.setRoot(a)}get app(){return this._app}setApp(t){this._app=t}get data(){return this._data}setData(t){this._data=t}get root(){return this._root}setRoot(t){this._root=t}render(){this.root.innerHTML="",this._header=new TableHeader(this),this._body=new TableBody(this),document.getElementById("touch-select").classList.remove("active"),document.getElementById("touch-controls").classList.add("hide")}}class TableBody{_table;_root;_rows;_touchSelectEnabled=!1;constructor(t){this.setTable(t),this.render()}get table(){return this._table}setTable(t){this._table=t}get root(){return this._root}setRoot(t){this._root=t}get rows(){return this._rows}setRows(t){this._rows=t}sort(t){t=[...t];const e=this.table.app._sort.order;let s,a=this.table.app._sort.by;t[0]&&!(a in t[0])&&(this.table.app._sort.order=a="_id");const o={_firstName:"_lastName",_lastName:"_firstName",_department:"_lastName",_location:"_lastName"},r=(t,e,r)=>{let i,n,l=1,c=-1;return a in o&&(i=t[o[a]],n=e[o[a]],s=!0),"desc"===r&&(l=-1,c=1),t=t[a],e=e[a],t instanceof Object&&(t=t._name,e=e._name),s?t.toLowerCase()>e.toLowerCase()?l:t.toLowerCase()<e.toLowerCase()?c:s?i>n?1:-1:0:t.toLowerCase()>e.toLowerCase()?l:t.toLowerCase()<e.toLowerCase()?c:0};return t.length>0&&(Number.isNaN(Number(t[0][a]))?"asc"===e?t=t.sort(((t,e)=>r(t,e,"asc"))):"desc"===e&&(t=t.sort(((t,e)=>r(t,e,"desc")))):"asc"===e?t=t.sort(((t,e)=>t[a]-e[a])):"desc"===e&&(t=t.sort(((t,e)=>e[a]-t[a])))),t}filterSearch(t){const e=0===this.table.app._search.length?[""]:this.table.app._search.split(" ").filter((t=>""!==t)),s=document.getElementById("no-results");return 0===(t=t.filter((t=>{let s=!1;for(let a in t)for(let o of e)if(t[a]instanceof Object&&(t[a]=t[a]._name),t[a]=t[a].toString(),t[a].toLowerCase().includes(o.toLowerCase())){s=!0;break}return s}))).length&&s.classList.contains("none")?s.classList.remove("none"):t.length>0&&!s.classList.contains("none")&&s.classList.add("none"),t}selectAllRows(){this._rows.forEach((t=>{t.root.className.includes("selected")||t.ctrlClick()}))}deselectAllRows(){this._rows.forEach((t=>{t.root.classList.remove("selected")})),this.table.app._selectedRows=[]}render(){const t=document.createElement("tbody");this.root&&this.root.remove(),this.setRoot(t),this.setRows(this.sort(this.filterSearch(this.table.data)).map((t=>new Row(t,this)))),this.table.root.append(this.root)}}class TableHeader{_table;_root;_row;constructor(t){this.setTable(t),this.render()}get table(){return this._table}setTable(t){this._table=t}get root(){return this._root}setRoot(t){this._root=t}get row(){return this._row}setRow(t){this._row=t}renderSortButton(){const t=this.row._cells,e=["asc","desc"],s=document.querySelector("#sort>ul");s.innerHTML="",t.forEach((t=>{let a=t.children[0].innerText,o=`_${K.toCamel(a)}`;"_name"!==o||"_name"in this.table._data[0]?(a=[a],o=[o]):(a=["First Name","Last Name"],o=["_firstName","_lastName"]),a.forEach(((a,r)=>{e.forEach((e=>{((t,e,a,o)=>{const r=document.createElement("li"),i=document.createElement("button");i.className="dropdown-item",i.innerHTML=`${t} ${e.toUpperCase()}`,i.addEventListener("click",(t=>{for(;this.table.app._sort.by!==a||this.table.app._sort.order!==e;)o.click()})),r.appendChild(i),s.appendChild(r)})(a,e,o[r],t)}))}))}))}render(){let t=Object.keys(this.table.data[0]);this.root&&this.root.remove(),this.setRoot(document.createElement("thead")),this.setRow(new Row(t,this,"th")),this.table.root.append(this.root),this.renderSortButton()}}class Row{_parent;_root;_data;_cells=[];constructor(t,e,s="td"){this.setParent(e),this.setData(t),this.render(s)}get data(){return this._data}setData(t){this._data=t}get parent(){return this._parent}setParent(t){this._parent=t}get root(){return this._root}setRoot(t){this._root=t}render(t){"th"===t?this.renderTH():this.renderTD()}handleHeaderClick(t){let e;const s=this.parent.table.app._sort.by,a=this.parent.table.app._sort.order;let o="_"+K.toCamel(t.target.innerText),r=["","asc","desc"];if(this._cells.forEach((t=>{t.className=""})),s!==o)"_name"!==o||o in this.parent.table._data[0]?(this.parent.table.app._sort.by=o,e=this.parent.table.app._sort.order="asc"):"_firstName"!==s&&"_lastName"!==s||"_lastName"===s&&""===a?(this.parent.table.app._sort.by="_firstName",e=this.parent.table.app._sort.order="asc"):"_firstName"===s&&"asc"===a?e=this.parent.table.app._sort.order="desc":"_firstName"===s&&"desc"===a?(this.parent.table.app._sort.by="_lastName",e=this.parent.table.app._sort.order="asc"):e=this.parent.table.app._sort.order="asc"===a?"desc":"";else{let t=r.findIndex((t=>a===t));2===t?t=0:t++,e=this.parent.table.app._sort.order=r[t]}""!==e&&t.currentTarget.classList.add(e),this.parent.table._body.render()}static isSelectedRow(t){return t.parent.table.app._selectedRows.includes(t)}handleClick(t,e){t.ctrlKey?e&&Row.isSelectedRow(this)||this.ctrlClick(t):t.shiftKey?this.shiftClick(t):this.click(t),e&&(this.parent.table.app._formModal.bs.show(),this.parent.table.app._formModal.handleModalShow(t)),this.parent.table.app.renderCRUDButtons()}click(t){const e=t.currentTarget.className.includes("selected");this.parent._rows.forEach((t=>{t.root.classList.remove("selected")})),this.parent.table.app._selectedRows=[],e||(this.root.classList.add("selected"),this.parent.table.app._selectedRows.push(this))}ctrlClick(){Row.isSelectedRow(this)?this.parent.table.app._selectedRows=this.parent.table.app._selectedRows.filter((t=>t!==this)):this.parent.table.app._selectedRows.push(this),this.root.classList.toggle("selected")}shiftClick(t){if(0===this.parent.table.app._selectedRows.length)this.click();else if(t.currentTarget===this.parent.table.app._selectedRows[0].element)this.parent.table.app._selectedRows.forEach((t=>{t.click()})),this.parent.table.app._selectedRows=[];else{const t=this.parent._rows.findIndex((t=>t===this.parent.table.app._selectedRows[0])),e=[t,this.parent._rows.findIndex((t=>t===this))].sort(((t,e)=>t>e?1:t<e?-1:0));this.parent.table.app._selectedRows.slice(1).forEach((t=>{t.ctrlClick()}));for(let s=e[0];s<=e[1];s++)s!==t&&this.parent._rows[s].ctrlClick()}}handleLongTouch(t){const e=document.getElementById("touch-controls");this._isLongTouch=!0,this.parent._touchSelectEnabled=!this.parent._touchSelectEnabled,this.parent._touchSelectEnabled?(e.classList.remove("hide"),this.ctrlClick()):(e.classList.add("hide"),this.parent.deselectAllRows())}renderTH(){this.setRoot(document.createElement("tr"));const t=document.createElement("th"),e=this.data.findIndex((t=>"_firstName"===t));e>-1&&(this.data[e]="_name",this.setData(this.data.slice(0,e+1).concat(this.data.slice(e+2)))),this.root.append(t),this.data.forEach((t=>{"ID"===(t=K.camelToTitle(t.slice(1))).toUpperCase()&&(t=t.toUpperCase());const e=document.createElement("th"),s=document.createElement("div");s.className="fw-semibold d-flex justify-content-between align-items-center",e.addEventListener("click",this.handleHeaderClick.bind(this)),this._cells.push(e),this.root.append(e),e.append(s),s.append(t),s.innerHTML+='<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 48 48"><path d="m14 28 10-10.05L34 28Z"/></svg>'})),this.parent.root.append(this.root)}handleTouchStart=t=>{const e=t.touches[0].clientX,s=t.touches[0].clientY,a=t.target instanceof HTMLButtonElement;let o=!1,r=!1;const i=setTimeout((()=>{r||(o=!0,this.handleLongTouch(t))}),1e3),n=t=>{const e=document.getElementById("touch-controls"),s=document.getElementById("touch-select");clearTimeout(i),!this.parent._touchSelectEnabled||o||r?this.parent._touchSelectEnabled||o||r||a&&Row.isSelectedRow(this)&&(t.preventDefault(),this.parent.table.app._formModal.bs.show(),this.parent.table.app._formModal.handleModalShow(t)):(t.preventDefault(),a&&Row.isSelectedRow(this)||(this.ctrlClick(),0===this.parent.table.app._selectedRows.length&&(e.classList.add("hide"),this.parent._touchSelectEnabled=!1),this.parent.table.app._selectedRows.length<this.parent._rows.length?s.classList.remove("active"):s.classList.add("active")),a&&(t.stopPropagation(),this.parent.table.app._formModal.bs.show(),this.parent.table.app._formModal.handleModalShow(t))),this.parent.table.app.renderCRUDButtons(),t.target.removeEventListener("touchend",n),t.target.removeEventListener("touchmove",l)},l=t=>{(t.touches[0].clientX>e+32||t.touches[0].clientX<e-32||t.touches[0].clientY>s+32||t.touches[0].clientY<s-32)&&(r=!0)};o&&(t.preventDefault(),touchSelect.classList.remove("active")),t.target.addEventListener("touchend",n),t.target.addEventListener("touchmove",l)};renderTD(){const t=this.parent.table.app._selectedRows.findIndex((t=>t.data===this.data));if(t<0){this.setRoot(document.createElement("tr"));const t=document.createElement("td"),e=document.createElement("button");let s=Object.keys(this.data),a=Object.values(this.data);const o=s.findIndex((t=>"_firstName"===t));e.className="btn btn-secondary fw-semibold hw-44 p-2 rounded-pill mx-auto",e.innerHTML="_firstName"in this.data?`${this.data._firstName.slice(0,1)}${this.data._lastName.slice(0,1)}`.toUpperCase():1===this.data.name.split(" ").length||this.data.name.split(" ").length>2?this.data.name.slice(0,2).toUpperCase():this.data.name.split(" ").map((t=>t.slice(0,1))).join(""),e.setAttribute("data-bs-target","#form-modal"),e.setAttribute("data-bs-type",`edit-${this.data.constructor.name.toLowerCase()}-readonly`),e.addEventListener("click",(t=>{t.stopPropagation(),this.handleClick.bind(this)(t,!0)})),e.addEventListener("touchstart",this.handleTouchStart.bind(this)),o>-1&&(a[o]=`${a[o]} ${a[o+1]}`,a=a.slice(0,o+1).concat(a.slice(o+2))),this.root.addEventListener("click",this.handleClick.bind(this)),this.root.addEventListener("touchstart",this.handleTouchStart.bind(this)),t.appendChild(e),this.root.append(t),a.forEach((t=>{t instanceof Object&&(t=t.name);const e=document.createElement("td"),s=document.createElement("div");e.setAttribute("data-bs-toggle","tooltip"),e.setAttribute("title",t),e.setAttribute("data-bs-delay",'{"show": 500, "hide": 0}'),this._cells.push(e),this.root.append(e),e.append(s),s.append(t)})),this.parent.root.append(this.root)}else this.setRoot(this.parent.table.app._selectedRows[t].root),this._cells=this.parent.table.app._selectedRows[t]._cells,this.parent.root.append(this.root),this.parent.table.app._selectedRows[t]=this}}export default Table;
